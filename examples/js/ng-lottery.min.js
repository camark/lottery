!function(){var t=angular.module("ngLottery",[]);t.config(["$httpProvider",function(t){t.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var e=function(t){var n,i,o,s,r,a,c,u="";for(n in t)if(i=t[n],i instanceof Array)for(c=0;c<i.length;++c)r=i[c],o=n+"["+c+"]",a={},a[o]=r,u+=e(a)+"&";else if(i instanceof Object)for(s in i)r=i[s],o=n+"["+s+"]",a={},a[o]=r,u+=e(a)+"&";else void 0!==i&&null!==i&&(u+=encodeURIComponent(n)+"="+encodeURIComponent(i)+"&");return u.length?u.substr(0,u.length-1):u};t.defaults.transformRequest=[function(t){return angular.isObject(t)&&"[object File]"!==String(t)?e(t):t}]}]),t.factory("LotteryRequest",["$http",function(t){var e=function(t){this.config=t};return e.prototype={_request:function(e,n){t.post(this.config.url,{ifName:this.config.ifName[e],data:JSON.stringify(this.config.data)}).success(function(t){0==t.code?(n.success||angular.noop)(t.result):(n.error||angular.noop)(t.msg)}).error(function(){(n.error||angular.noop)("服务器繁忙，连接失败！")})},get:function(t){this._request(0,t)},post:function(t){this._request(1,t)}},e}]),t.service("lotteryState",function(){return function(t,e){-1!=t&&(3==t?alert("亲，活动还未开始！","z-warn"):2==t?alert("亲，活动已经结束！","z-warn"):1==t?alert("亲，活动暂停中！","z-warn"):e())}}),t.factory("Lottery",function(){var t,e=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};return function(t){var n=function(){function t(){}return t["extends"]=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];t=t||{};for(var i=1;i<arguments.length;i++)if(arguments[i])for(var o in arguments[i])arguments[i].hasOwnProperty(o)&&(t[o]=arguments[i][o]);return t},t.camelCase=function(t){return t.replace(/-([a-z])/gi,function(t,e){return e.toUpperCase()})},t.css=function(t,e,n){if(void 0===t.style[e])for(var i=0;i<this._vendors.length&&(e=this.camelCase(this._vendors[i]+"-"+e),void 0===t.style[e]);i++);return t.style[e]=n,e},t._vendors=["webkit","ms","moz","o"],t}(),i=function(){function t(){this._queue={}}return t.prototype.on=function(t,e){return this._queue[t]=this._queue[t]||[],this._queue[t].push(e),this},t.prototype.off=function(t,e){if(!this._queue[t])return this;var n="undefined"==typeof e?-2:this._queue[t].indexOf(e);return-2==n?delete this._queue[t]:-1!=n&&this._queue[t].splice(n,1),this._queue[t]&&0==this._queue[t].length&&delete this._queue[t],this},t.prototype.has=function(t){return!!this._queue[t]},t.prototype.trigger=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(!this._queue[t])return this;for(var i=0;i<this._queue[t].length;i++)this._queue[t][i].apply(null,e);return this},t}(),o=function(){function t(t,e){this.index=0,this.state=0,this.elem=t,this.items=t.children,this.height=this.items[0].clientHeight,this.elem.appendChild(this.items[0].cloneNode(!0)),e&&window.addEventListener("onorientationchange"in document?"orientationchange":"resize",this._onResize.bind(this))}return t.prototype.reset=function(){this.elem.classList.remove("fx-roll"),this.elem.style.marginTop=0,this.callback=null,this.index=0,this.state=0},t.prototype.start=function(t){var e=this;void 0===t&&(t=0),this.state=1,setTimeout(function(){1==e.state&&(e.elem.style.marginTop=0,e.elem.classList.add("fx-roll"))},t)},t.prototype.stop=function(t,e,n){var i=this;void 0===n&&(n=0),this.callback=e,this.index=t,setTimeout(function(){1==i.state&&(i.elem.style.marginTop=-t*i.height+"px",i.elem.classList.remove("fx-roll"),i.elem.classList.add("fx-bounce"),window.animationEnd(i.elem,function(){i.state=0,i.elem.classList.remove("fx-bounce"),i.callback&&i.callback.call(i)},!0))},n)},t.prototype._onResize=function(){this.height=this.items[0].clientHeight,this.elem.classList.contains("fx-roll")||(this.elem.style.marginTop=-this.index*this.height+"px")},t}(),s=function(t){function i(e,i){var o=this;t.call(this),this.config={speed:30,areaNumber:8},this._transform="transform",this._runAngle=0,this._targetAngle=-1,this.pointer=e,this.config=n["extends"]({},this.config,i),this._transform=n.css(this.pointer,this._transform,"translate3d(0,0,0)"),n.css(this.pointer,"backfaceVisibility","hidden"),n.css(this.pointer,"perspective","1000px"),this.on("__setResult",function(t){var e=360/o.config.areaNumber,n=Math.ceil(Math.random()*e+t*e);o._runAngle=0,o._targetAngle=n+360*(Math.floor(4*Math.random())+4)})}return e(i,t),i.prototype.setResult=function(t){this.trigger("__setResult",t)},i.prototype.reset=function(t){void 0===t&&(t="reset"),this._raf&&(window.cancelAnimationFrame(this._raf),this._raf=null,this._runAngle=0,this._targetAngle=-1,this.trigger(t),"reset"==t&&n.css(this.pointer,this._transform,"translate3d(0,0,0) rotate(0deg)"))},i.prototype.draw=function(){if(!this._raf){var t=function(){var t=0,e=function(){-1==this._targetAngle?this._runAngle+=this.config.speed:(t=(this._targetAngle-this._runAngle)/this.config.speed,t=t>this.config.speed?this.config.speed:.5>t?.5:t,this._runAngle+=t,this._runAngle=this._runAngle>this._targetAngle?this._targetAngle:this._runAngle),n.css(this.pointer,this._transform,"translate3d(0,0,0) rotate("+this._runAngle%360+"deg)"),this._runAngle==this._targetAngle?this.reset("end"):this._raf=window.requestAnimationFrame(e.bind(this))};this._raf=window.requestAnimationFrame(e.bind(this))};this.has("start")?this.trigger("start",t.bind(this)):t.call(this)}},i}(i);t.Dial=s;var r=function(t){function i(e,i){t.call(this),this.config={size:20,percent:50,variable:!0},this._state="load",this._touch=!1,this._request=!1,this.canvas=e,this.ctx=e.getContext("2d"),this.config=n["extends"]({},this.config,i),this._state="init",this._init(),this.canvas.addEventListener("ontouchstart"in document?"touchstart":"mousedown",this._onTouchStart.bind(this),!1),this.canvas.addEventListener("ontouchmove"in document?"touchmove":"mousemove",this._onTouchMove.bind(this),!1),document.addEventListener("ontouchend"in document?"touchend":"mouseup",this._onTouchEnd.bind(this)),window.addEventListener("onorientationchange"in document?"orientationchange":"resize",this._onResize.bind(this))}return e(i,t),i.prototype.setResult=function(t){this.canvas.style.backgroundImage="url("+t+")"},i.prototype.draw=function(){"end"!=this._state&&(this.ctx.clearRect(0,0,this.width,this.height),this._state="end",this.trigger("end"))},i.prototype.reset=function(){this._state="init",this._request=!1,this._touch=!1,this.canvas.style.backgroundImage=null,this._init(),this.trigger("reset")},i.prototype._init=function(){this._setCanvasSize(),this._getCanvasOffset(),this.ctx.closePath(),this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="gray",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.globalCompositeOperation="destination-out"},i.prototype._scratchPercent=function(){for(var t=0,e=this.ctx.getImageData(0,0,this.width,this.height),n=0,i=e.data.length;i>n;n+=4)0===e.data[n]&&0===e.data[n+1]&&0===e.data[n+2]&&0===e.data[n+3]&&t++;return t/(this.width*this.height)*100},i.prototype._setCanvasSize=function(){this.width=this.canvas.clientWidth,this.height=this.canvas.clientHeight,this.canvas.width=this.width,this.canvas.height=this.height},i.prototype._getCanvasOffset=function(){var t=this.canvas.getBoundingClientRect(),e=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop,n=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,i=document.documentElement.clientTop||document.body.clientTop||0,o=document.documentElement.clientLeft||document.body.clientLeft||0;this.offsetX=Math.round(t.left+n-o),this.offsetY=Math.round(t.top+e-i)},i.prototype._getEventXY=function(t){return t=t.changedTouches?t.changedTouches[0]:t,{x:t.pageX-this.offsetX,y:t.pageY-this.offsetY}},i.prototype._onTouchStart=function(t){if(t.preventDefault(),"end"!=this._state){var e=function(t){var e=this._getEventXY(t);this._state="start",this._touch=!0,this._request=!0,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,this.config.size/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.lineWidth=this.config.size,this.ctx.moveTo(e.x,e.y)};this.has("start")&&!this._request?this.trigger("start",e.bind(this,t)):e.call(this,t)}},i.prototype._onTouchMove=function(t){if(t.preventDefault(),this._touch){var e=this._getEventXY(t);this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}},i.prototype._onTouchEnd=function(t){if(this._touch){var e=this._getEventXY(t);this._touch=!1,this.ctx.closePath(),this.ctx.beginPath(),this.ctx.arc(e.x,e.y,this.config.size/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),this._scratchPercent()>=this.config.percent&&(this.ctx.clearRect(0,0,this.width,this.height),this._state="end",this.trigger("end"))}},i.prototype._onResize=function(){this._touch=!1,this.config.variable?"end"==this._state?this._setCanvasSize():this._init():this._getCanvasOffset()},i}(i);t.Scratch=r;var a=function(t){function i(e,i,s){t.call(this),this.config={timeout:300,timeDiff:6e3,variable:!0},this.rollerQueue=[],this.toggle=e,this.config=n["extends"]({},this.config,s);for(var r=0;r<i.length;r++)this.rollerQueue.push(new o(i[r],this.config.variable))}return e(i,t),i.prototype.setResult=function(t){var e=this,n=(new Date).getTime();setTimeout(function(){for(var n=0,i=e.rollerQueue.length;i>n;n++)e.rollerQueue[n].stop(t[n],n==i-1?function(){e.toggle.classList.remove("z-active"),e.trigger("end")}:null,n*e.config.timeout)},n-this._startTime>this.config.timeDiff?0:this.config.timeDiff-(n-this._startTime))},i.prototype.reset=function(){this.toggle.classList.remove("z-active");for(var t=0,e=this.rollerQueue.length;e>t;t++)this.rollerQueue[t].reset();this.trigger("reset")},i.prototype.draw=function(){if(!this.toggle.classList.contains("z-active")){var t=function(){this.toggle.classList.add("z-active");for(var t=0,e=this.rollerQueue.length;e>t;t++)this.rollerQueue[t].start(t*this.config.timeout)};this._startTime=(new Date).getTime(),this.has("start")?this.trigger("start",t.bind(this)):t.call(this)}},i}(i);t.Tiger=a}(t||(t={})),t}),t.directive("uiLotteryScratch",["$timeout","Lottery","LotteryRequest","lotteryState","lotteryConfig",function(t,e,n,i,o){return{restrict:"A",scope:{lottery:"=",onReady:"&",onResult:"&"},controller:["$scope",function(t){t.lottery={state:-1,result:null,config:null,start:angular.noop,reset:angular.noop}}],link:function(s,r,a){var c=o.timeout||500,u=new n(o.request),l=function(){var n=new e.Scratch(r[0].querySelector("canvas"),o.game||{});n.on("start",function(t){t(),u.post({success:function(t){n.setResult(t.web_des),s.lottery.result=t},error:function(t){n.reset(),alert(t,"z-error")}})}).on("end",function(){t(function(){s.lottery.state=3,s.onResult({result:s.lottery.result})},c)}).on("reset",function(){s.lottery.result=null,s.lottery.state=0}),s.lottery.start=function(){i(s.lottery.config?s.lottery.config.state:-1,function(){s.lottery.state=0==s.lottery.state?1:s.lottery.state})},s.lottery.reset=function(){n.reset(),s.lottery.state=1}};u.get({success:function(e){s.lottery.state=0,s.lottery.config=e,s.onReady({config:e}),t(l,50)},error:function(t){alert(t,"z-error")}})}}}]),t.directive("uiLotteryDial",["$timeout","Lottery","LotteryRequest","lotteryState","lotteryConfig",function(t,e,n,i,o){return{restrict:"A",scope:{lottery:"=",onReady:"&",onResult:"&"},template:'<div class="dial" ng-style="lottery.dialBackground"></div><div class="pointer" ng-style="lottery.pointerBackground"><span class="toggle" ng-click="lottery.start()"></span></div>',controller:["$scope",function(t){t.lottery={result:null,config:null,start:angular.noop,dialBackground:{},pointerBackground:{}}}],link:function(s,r,a){var c=new n(o.request),u=function(){var t=new e.Dial(r[0].querySelector(".pointer"),o.game||{});t.on("start",function(e){e(),c.post({success:function(e){t.setResult(e.sectors_number),s.lottery.result=e},error:function(e){t.reset(),alert(e,"z-error")}})}).on("end",function(){s.onResult({result:s.lottery.result})}).on("reset",function(){s.lottery.result=null}),s.lottery.start=function(){i(s.lottery.config?s.lottery.config.state:-1,t.draw.bind(t))}};c.get({success:function(e){s.lottery.config=e,s.lottery.dialBackground={"background-image":"url("+e.back_web_des+")"},s.lottery.pointerBackground={"background-image":"url("+e.btn_web_des+")"},s.onReady({config:e}),t(u,50)},error:function(t){alert(t,"z-error")}})}}}]),t.directive("uiLotteryTiger",["$timeout","Lottery","LotteryRequest","lotteryState","lotteryConfig",function(t,e,n,i,o){return{restrict:"A",scope:{lottery:"=",onReady:"&",onResult:"&"},template:'<div class="back" ng-style="lottery.backBackground"><div class="item" ng-repeat="rank in ranks"><ul class="roller"><li ng-repeat="img in lottery.config.prize_web_des"><img ng-src="{{img}}"/></li></ul></div></div><div class="btn" ng-style="lottery.btnBackground"><span class="toggle" ng-click="lottery.start()"></span></div>',controller:["$scope",function(t){t.lottery={result:null,config:null,start:angular.noop,backBackground:{},btnBackground:{}}}],link:function(s,r,a){o.rankCount=o.rankCount||3,s.ranks=[];for(var c=0;c<o.rankCount;c++)s.ranks[c]=c;var u=new n(o.request),l=function(){var t=new e.Tiger(r[0].querySelector(".toggle"),r[0].querySelectorAll(".roller"),o.game);t.on("start",function(e){e(),u.post({success:function(e){t.setResult(e.sectors_index),s.lottery.result=e},error:function(e){t.reset(),alert(e,"z-error")}})}).on("end",function(){s.onResult({result:s.lottery.result})}).on("reset",function(){s.lottery.result=null}),s.lottery.start=function(){i(s.lottery.config?s.lottery.config.state:-1,t.draw.bind(t))}};u.get({success:function(e){s.lottery.config=e,s.lottery.backBackground={"background-image":"url("+e.back_web_des+")"},s.lottery.btnBackground={"background-image":"url("+e.btn_web_des+")"},s.onReady({config:e}),t(l,50)},error:function(t){alert(t,"z-error")}})}}}]),t.directive("uiLotteryButton",["LotteryRequest","lotteryState","lotteryConfig",function(t,e,n){return{restrict:"A",scope:{lottery:"=",onReady:"&",onResult:"&"},controller:["$scope",function(t){t.lottery={state:-1,result:null,config:null,start:angular.noop}}],link:function(i,o,s){var r=new t(n.request);r.get({success:function(t){i.lottery.state=0,i.lottery.config=t,i.onReady({config:t})},error:function(t){alert(t,"z-error")}}),i.lottery.start=function(){0==i.lottery.state&&e(i.lottery.config?i.lottery.config.state:-1,function(){i.lottery.state=1,r.post({success:function(t){i.lottery.state=0,i.lottery.result=t,i.onResult({result:t})},error:function(t){i.lottery.state=0,alert(t,"z-error")}})})}}}}])}();